<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Venue Manager â€” Shows & TurnÃªs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { 50:'#eff6ff',100:'#dbeafe',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',800:'#1e40af',900:'#1e3a8a' } } } }
    }
  </script>
  <style>
    body { font-family: system-ui, sans-serif; }
    .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 2px; }
    input[type=number] { -moz-appearance: textfield; }
    input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
    @media print { .no-print { display: none !important; } }
  </style>
</head>
<body class="bg-slate-50">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useContext, createContext } = React;

// â”€â”€â”€ VENUE CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VenueCtx = createContext({ allVenues: [], allVenueMap: {}, addCustomVenue: () => {}, deleteCustomVenue: () => {} });

// â”€â”€â”€ STATIC VENUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VENUES = [
  {
    id: 'espaÃ§o-unimed-sp', name: 'EspaÃ§o Unimed', city: 'SÃ£o Paulo', state: 'SP',
    totalCapacity: 3250, cortesias: 80,
    sectors: [
      { id: 'platinum',   name: 'PLATINUM',     capacity: 360,  priceInteira: 500, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'azul-prem',  name: 'AZUL PREMIUM', capacity: 372,  priceInteira: 350, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'azul-a',     name: 'AZUL e A',     capacity: 572,  priceInteira: 280, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'bcd',        name: 'B, C e D',     capacity: 552,  priceInteira: 200, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'efgh',       name: 'E, F, G e H',  capacity: 672,  priceInteira: 150, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'ijk',        name: 'I, J e K',     capacity: 396,  priceInteira: 100, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'pcd',        name: 'PCD',           capacity: 36,   priceInteira: 100, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'mezanino',   name: 'MEZANINO',      capacity: 56,   priceInteira: 280, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote-a', name: 'CAMAROTE A',    capacity: 64,   priceInteira: 450, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote-b', name: 'CAMAROTE B',    capacity: 90,   priceInteira: 450, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'pct', locacaoValue: 0.40, producao: 182690, logistica: 26400, backline: 10000, iluminacao: 30000, som: 30000, led: 30000, outros: 800 },
    taxes: { issPis: 0.0565, ecad: 0.04 },
  },
  {
    id: 'vivo-rio-rj', name: 'Vivo Rio', city: 'Rio de Janeiro', state: 'RJ',
    totalCapacity: 2066, cortesias: 188,
    sectors: [
      { id: 'camarote-a', name: 'CAMAROTE A', capacity: 94,  priceInteira: 400, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote-b', name: 'CAMAROTE B', capacity: 80,  priceInteira: 400, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote-c', name: 'CAMAROTE C', capacity: 88,  priceInteira: 400, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'frisa',      name: 'FRISA',      capacity: 48,  priceInteira: 250, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'setor1',     name: 'SETOR 1',    capacity: 388, priceInteira: 250, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'setor2',     name: 'SETOR 2',    capacity: 400, priceInteira: 250, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'setor3',     name: 'SETOR 3',    capacity: 240, priceInteira: 200, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0 },
      { id: 'setor4',     name: 'SETOR 4',    capacity: 288, priceInteira: 200, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0 },
      { id: 'setor5',     name: 'SETOR 5',    capacity: 252, priceInteira: 80,  splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 120000, producao: 201600, logistica: 26400, backline: 5000, iluminacao: 30000, som: 30000, led: 28000, outros: 600 },
    taxes: { issPis: 0.0565, ecad: 0.04 },
  },
  {
    id: 'befly-hall-bh', name: 'BeFly Hall', city: 'Belo Horizonte', state: 'MG',
    totalCapacity: 3574, cortesias: 160,
    sectors: [
      { id: 'pista',        name: 'PISTA',        capacity: 1094, priceInteira: 340, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'arquibancada', name: 'ARQUIBANCADA', capacity: 2320, priceInteira: 220, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 85000, producao: 174520, logistica: 26400, backline: 5000, iluminacao: 30000, som: 30000, led: 10000, outros: 800 },
    taxes: { issPis: 0.0565, ecad: 0.05 },
  },
  {
    id: 'araujo-viana-poa', name: 'AraÃºjo Viana', city: 'Porto Alegre', state: 'RS',
    totalCapacity: 4228, cortesias: 150,
    sectors: [
      { id: 'gold',      name: 'PLATEIA GOLD',       capacity: 208,  priceInteira: 500, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'baixa-cen', name: 'BAIXA CENTRAL',      capacity: 500,  priceInteira: 340, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'baixa-lat', name: 'BAIXA LATERAL',      capacity: 618,  priceInteira: 280, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'alta-cen',  name: 'ALTA CENTRAL',       capacity: 1334, priceInteira: 220, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'alta-lat',  name: 'ALTA LATERAL',       capacity: 338,  priceInteira: 200, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'bistro',    name: 'MESAS BISTRÃ”',       capacity: 80,   priceInteira: 340, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'pista-dir', name: 'PISTA LATERAL DIR.', capacity: 500,  priceInteira: 180, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'pista-esq', name: 'PISTA LATERAL ESQ.', capacity: 500,  priceInteira: 180, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'pct', locacaoValue: 0.15, producao: 124317, logistica: 26400, backline: 5000, iluminacao: 15000, som: 15000, led: 10000, outros: 800 },
    taxes: { issPis: 0.0565, ecad: 0.05 },
  },
  {
    id: 'opera-arame-cwb', name: 'Ã“pera de Arame', city: 'Curitiba', state: 'PR',
    totalCapacity: 1644, cortesias: 88,
    sectors: [
      { id: 'vip',      name: 'VIP',      capacity: 10,   priceInteira: 290, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'plateia',  name: 'PLATEIA',  capacity: 1364, priceInteira: 260, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote', name: 'CAMAROTE', capacity: 174,  priceInteira: 240, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'pcd',      name: 'PCD',      capacity: 8,    priceInteira: 220, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 24200, producao: 84500, logistica: 26400, backline: 5000, iluminacao: 30000, som: 30000, led: 15000, outros: 800 },
    taxes: { issPis: 0.02, ecad: 0.05 },
  },
  {
    id: 'cine-teatro-for', name: 'Cine Teatro SÃ£o Luiz', city: 'Fortaleza', state: 'CE',
    totalCapacity: 1042, cortesias: 88,
    sectors: [
      { id: 'vip',      name: 'VIP',      capacity: 10,  priceInteira: 290, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'plateia',  name: 'PLATEIA',  capacity: 762, priceInteira: 260, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote', name: 'CAMAROTE', capacity: 174, priceInteira: 240, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'pcd',      name: 'PCD',      capacity: 8,   priceInteira: 220, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 70000, producao: 50000, logistica: 0, backline: 5000, iluminacao: 15000, som: 15000, led: 10000, outros: 0 },
    taxes: { issPis: 0.0565, ecad: 0.05 },
  },
  {
    id: 'castro-alves-ssa', name: 'Teatro Castro Alves', city: 'Salvador', state: 'BA',
    totalCapacity: 1542, cortesias: 88,
    sectors: [
      { id: 'vip',      name: 'VIP',      capacity: 10,   priceInteira: 290, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'plateia',  name: 'PLATEIA',  capacity: 1262, priceInteira: 260, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote', name: 'CAMAROTE', capacity: 174,  priceInteira: 240, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'pcd',      name: 'PCD',      capacity: 8,    priceInteira: 220, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'pct', locacaoValue: 0.07, producao: 125000, logistica: 0, backline: 5000, iluminacao: 40000, som: 40000, led: 35000, outros: 800 },
    taxes: { issPis: 0.0565, ecad: 0.05 },
  },
  {
    id: 'ibirapuera-sp', name: 'EspaÃ§o Ibirapuera', city: 'SÃ£o Paulo', state: 'SP',
    totalCapacity: 15800, cortesias: 2200,
    sectors: [
      { id: 'pista',     name: 'PISTA',     capacity: 13000, priceInteira: 200, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'auditorio', name: 'AUDITÃ“RIO', capacity: 600,   priceInteira: 500, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 500000, producao: 700000, logistica: 0, backline: 0, iluminacao: 0, som: 0, led: 0, outros: 0 },
    taxes: { issPis: 0.0565, ecad: 0.05 },
  },
  {
    id: 'guaira-cwb', name: 'Teatro GuaÃ­ra', city: 'Curitiba', state: 'PR',
    totalCapacity: 2119, cortesias: 88,
    sectors: [
      { id: 'plateia', name: 'PLATEIA', capacity: 1500, priceInteira: 160, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'balcao',  name: 'BALCÃƒO',  capacity: 531,  priceInteira: 120, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 60000, producao: 118210, logistica: 26400, backline: 5000, iluminacao: 30000, som: 30000, led: 15000, outros: 800 },
    taxes: { issPis: 0.0565, ecad: 0.05 },
  },
  {
    id: 'teatro-amazonas-mao', name: 'Teatro Amazonas', city: 'Manaus', state: 'AM',
    totalCapacity: 701, cortesias: 30,
    sectors: [
      { id: 'plateia',  name: 'PLATEIA',  capacity: 471, priceInteira: 140, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote', name: 'CAMAROTE', capacity: 200, priceInteira: 200, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 30000, producao: 66667, logistica: 0, backline: 5000, iluminacao: 15000, som: 15000, led: 10000, outros: 0 },
    taxes: { issPis: 0.05, ecad: 0.05 },
  },
  {
    id: 'teatro-paz-bel', name: 'Teatro da Paz', city: 'BelÃ©m', state: 'PA',
    totalCapacity: 900, cortesias: 30,
    sectors: [
      { id: 'plateia', name: 'PLATEIA', capacity: 870, priceInteira: 120, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 30000, producao: 66667, logistica: 0, backline: 5000, iluminacao: 15000, som: 15000, led: 10000, outros: 0 },
    taxes: { issPis: 0.05, ecad: 0.05 },
  },
  {
    id: 'arena-jockey-rj', name: 'Arena Jockey', city: 'Rio de Janeiro', state: 'RJ',
    totalCapacity: 3550, cortesias: 100,
    sectors: [
      { id: 'cadeira-azul',    name: 'CADEIRA AZUL',    capacity: 672,  priceInteira: 260, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'cadeira-amarela', name: 'CADEIRA AMARELA', capacity: 1136, priceInteira: 220, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'cadeira-verde',   name: 'CADEIRA VERDE',   capacity: 1168, priceInteira: 180, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'cadeira-branca',  name: 'CADEIRA BRANCA',  capacity: 329,  priceInteira: 140, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
      { id: 'camarote',        name: 'CAMAROTE',        capacity: 145,  priceInteira: 400, splitMeia: 0.4, splitSolidario: 0.5, splitInteira: 0.1 },
    ],
    costs: { locacaoType: 'fixed', locacaoValue: 250000, producao: 150000, logistica: 26400, backline: 0, iluminacao: 0, som: 0, led: 0, outros: 800 },
    taxes: { issPis: 0.03, ecad: 0.05 },
  },
];

// â”€â”€â”€ COST CATEGORIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COST_LABELS = {
  ecad: 'ECAD', issPis: 'ISS+PIS/COFINS',
  locacao: 'LocaÃ§Ã£o',
  producao: 'ProduÃ§Ã£o', cachet: 'CachÃª do Artista',
  backline: 'Backline', iluminacao: 'IluminaÃ§Ã£o', som: 'SonorizaÃ§Ã£o', led: 'LED / Telas',
  logistica: 'LogÃ­stica',
  outros: 'Outros', extras: 'Custos Extras',
};

// For DRE display (includes taxes)
const DRE_CATS = [
  { id: 'deducoes', label: 'DeduÃ§Ãµes Legais',     keys: ['ecad','issPis'],                       hBg: 'bg-orange-100', hTxt: 'text-orange-800' },
  { id: 'venue',    label: 'Venue',                keys: ['locacao'],                               hBg: 'bg-purple-100', hTxt: 'text-purple-800' },
  { id: 'prod',     label: 'ProduÃ§Ã£o ArtÃ­stica',   keys: ['producao','cachet'],                   hBg: 'bg-blue-100',   hTxt: 'text-blue-800'   },
  { id: 'tecnica',  label: 'TÃ©cnica',              keys: ['backline','iluminacao','som','led'],    hBg: 'bg-indigo-100', hTxt: 'text-indigo-800' },
  { id: 'logist',   label: 'LogÃ­stica',            keys: ['logistica'],                             hBg: 'bg-teal-100',   hTxt: 'text-teal-800'   },
  { id: 'outros',   label: 'Outros',               keys: ['outros','extras'],                       hBg: 'bg-slate-100',  hTxt: 'text-slate-700'  },
];

// For ShowForm overrides (no taxes, locaÃ§Ã£o handled separately)
const OVERRIDE_CATS = [
  { id: 'prod',    label: 'ProduÃ§Ã£o ArtÃ­stica', keys: ['producao'],                              hBg: 'bg-blue-50',   hTxt: 'text-blue-700'   },
  { id: 'tecnica', label: 'TÃ©cnica',            keys: ['backline','iluminacao','som','led'],    hBg: 'bg-indigo-50', hTxt: 'text-indigo-700' },
  { id: 'logist',  label: 'LogÃ­stica',          keys: ['logistica'],                             hBg: 'bg-teal-50',   hTxt: 'text-teal-700'   },
  { id: 'outros',  label: 'Outros',             keys: ['outros'],                                hBg: 'bg-slate-50',  hTxt: 'text-slate-600'  },
];

const CAT_IDS = ['venue','prod','tecnica','logist','outros'];

// â”€â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const loadBudgets      = () => { try { return JSON.parse(localStorage.getItem('vm_budgets') || '[]'); } catch { return []; } };
const saveBudgets      = b  => localStorage.setItem('vm_budgets', JSON.stringify(b));
const loadCustomVenues = () => { try { return JSON.parse(localStorage.getItem('vm_custom_venues') || '[]'); } catch { return []; } };
const saveCustomVenues = v  => localStorage.setItem('vm_custom_venues', JSON.stringify(v));

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uid    = () => Math.random().toString(36).slice(2, 10);
const fmtR   = v  => 'R$ ' + (v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const fmtPct = v  => ((v || 0) * 100).toFixed(1) + '%';

// â”€â”€â”€ MODEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_SPLITS        = { meia: 0.4, solidario: 0.5, inteira: 0.1 };
const DEFAULT_SOLIDARIO_PCT = 67.5;
const DEFAULT_LOCACAO_OV    = { type: 'template', value: 0, pct: 0 };
const DEFAULT_CAT_COSTS     = () => ({ venue: [], prod: [], tecnica: [], logist: [], outros: [] });

function defaultSectorQtys(s, splits, solidarioPct) {
  const sp  = splits || { meia: s.splitMeia, solidario: s.splitSolidario, inteira: s.splitInteira };
  const sol = solidarioPct != null ? solidarioPct : DEFAULT_SOLIDARIO_PCT;
  return {
    qtyMeia:        Math.round(s.capacity * sp.meia),
    qtySolidario:   Math.round(s.capacity * sp.solidario),
    qtyInteira:     Math.round(s.capacity * sp.inteira),
    priceMeia:      parseFloat((s.priceInteira * 0.5).toFixed(2)),
    priceSolidario: parseFloat((s.priceInteira * sol / 100).toFixed(2)),
    priceInteira:   s.priceInteira,
  };
}

function makeShow(venueId, allVenueMap) {
  const venue = allVenueMap[venueId];
  if (!venue) return null;
  const splits      = { ...DEFAULT_SPLITS };
  const solidarioPct = DEFAULT_SOLIDARIO_PCT;
  return {
    id: uid(), venueId, date: '', cachet: 0,
    splits, solidarioPct,
    locacaoOverride: { ...DEFAULT_LOCACAO_OV },
    categoryCosts:   DEFAULT_CAT_COSTS(),
    sectors: venue.sectors.map(s => ({ id: s.id, name: s.name, capacity: s.capacity, ...defaultSectorQtys(s, splits, solidarioPct) })),
    costOverrides: {}, extraCosts: [],
  };
}

function makeBudget() {
  return { id: uid(), name: 'Novo OrÃ§amento', artist: '', createdAt: new Date().toISOString(), shows: [] };
}

// â”€â”€â”€ CALCULATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcSectorRevenue(sec) {
  return (sec.qtyMeia * sec.priceMeia) + (sec.qtySolidario * sec.priceSolidario) + (sec.qtyInteira * sec.priceInteira);
}

function calcShow(show, venueMap) {
  const venue = venueMap[show.venueId];
  if (!venue) return null;
  const ov = show.costOverrides || {};

  const revenue = show.sectors.reduce((s, sec) => s + calcSectorRevenue(sec), 0);
  const ecad    = revenue * venue.taxes.ecad;
  const issPis  = revenue * venue.taxes.issPis;

  // LocaÃ§Ã£o â€” supports template / fixed / % per show
  const locOv = show.locacaoOverride || DEFAULT_LOCACAO_OV;
  let locacao;
  if (locOv.type === 'fixed') {
    locacao = parseFloat(locOv.value) || 0;
  } else if (locOv.type === 'pct') {
    locacao = (parseFloat(locOv.pct) || 0) / 100 * revenue;
  } else {
    // template (or legacy costOverride.locacao)
    locacao = ov.locacao != null ? ov.locacao
      : venue.costs.locacaoType === 'pct' ? venue.costs.locacaoValue * revenue
      : venue.costs.locacaoValue;
  }

  const producao   = ov.producao   != null ? ov.producao   : venue.costs.producao;
  const logistica  = ov.logistica  != null ? ov.logistica  : venue.costs.logistica;
  const backline   = ov.backline   != null ? ov.backline   : venue.costs.backline;
  const iluminacao = ov.iluminacao != null ? ov.iluminacao : venue.costs.iluminacao;
  const som        = ov.som        != null ? ov.som        : venue.costs.som;
  const led        = ov.led        != null ? ov.led        : venue.costs.led;
  const outros     = ov.outros     != null ? ov.outros     : venue.costs.outros;

  // Per-category custom costs
  const cc = show.categoryCosts || {};
  const catCosts = {};
  let catExtrasTotal = 0;
  CAT_IDS.forEach(id => {
    const total = (cc[id] || []).reduce((s, e) => s + (parseFloat(e.value) || 0), 0);
    catCosts[id] = total;
    catExtrasTotal += total;
  });

  // Legacy flat extra costs
  const legacyExtras = (show.extraCosts || []).reduce((s, e) => s + (parseFloat(e.value) || 0), 0);
  const extras = legacyExtras;

  const cachet     = parseFloat(show.cachet) || 0;
  const totalCosts = ecad + issPis + locacao + producao + logistica + backline + iluminacao + som + led + outros + extras + catExtrasTotal + cachet;
  const result     = revenue - totalCosts;
  const totalSold  = show.sectors.reduce((s, sec) => s + sec.qtyMeia + sec.qtySolidario + sec.qtyInteira, 0);
  const totalCapacity = show.sectors.reduce((s, sec) => s + sec.capacity, 0);
  const ticketMedio = totalSold > 0 ? revenue / totalSold : 0;

  return { revenue, ecad, issPis, locacao, producao, logistica, backline, iluminacao, som, led, outros, extras, cachet, catCosts, catExtrasTotal, totalCosts, result, margin: revenue > 0 ? result / revenue : 0, totalSold, totalCapacity, occupancy: totalCapacity > 0 ? totalSold / totalCapacity : 0, ticketMedio };
}

function calcBudget(budget, venueMap) {
  const showCalcs   = budget.shows.map(s => calcShow(s, venueMap));
  const revenue     = showCalcs.reduce((s, c) => s + (c?.revenue    || 0), 0);
  const totalCosts  = showCalcs.reduce((s, c) => s + (c?.totalCosts || 0), 0);
  const totalSold   = showCalcs.reduce((s, c) => s + (c?.totalSold  || 0), 0);
  const result      = revenue - totalCosts;
  const ticketMedio = totalSold > 0 ? revenue / totalSold : 0;
  return { shows: showCalcs, revenue, totalCosts, result, margin: revenue > 0 ? result / revenue : 0, totalSold, ticketMedio };
}

// â”€â”€â”€ EXCEL EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportToExcel(budget, venueMap) {
  const wb   = XLSX.utils.book_new();
  const rows = [['Show','Venue','Data','Receita Bruta','Ticket MÃ©dio','ECAD','ISS+PIS','LocaÃ§Ã£o','ProduÃ§Ã£o','CachÃª','Backline','IluminaÃ§Ã£o','Som','LED','LogÃ­stica','Outros','Extras','Cat.Extras','Total Custos','Resultado','Margem','Vendido','OcupaÃ§Ã£o']];
  budget.shows.forEach((show, i) => {
    const c = calcShow(show, venueMap); const v = venueMap[show.venueId];
    if (!c) return;
    rows.push([`Show ${i+1}`, v?.name||'', show.date, c.revenue, c.ticketMedio, c.ecad, c.issPis, c.locacao, c.producao, c.cachet, c.backline, c.iluminacao, c.som, c.led, c.logistica, c.outros, c.extras, c.catExtrasTotal, c.totalCosts, c.result, c.margin, c.totalSold, c.occupancy]);
  });
  const calc = calcBudget(budget, venueMap);
  rows.push([], ['TOTAL','','',calc.revenue,calc.ticketMedio,'','','','','','','','','','','','','',calc.totalCosts,calc.result,calc.margin,calc.totalSold,'']);
  const ws = XLSX.utils.aoa_to_sheet(rows); ws['!cols'] = rows[0].map(() => ({ wch: 16 }));
  XLSX.utils.book_append_sheet(wb, ws, 'DRE Consolidada');
  budget.shows.forEach((show, i) => {
    const v = venueMap[show.venueId];
    const sr = [['Setor','Capacidade','Qtd Meia','PreÃ§o Meia','Rec. Meia','Qtd SolidÃ¡rio','PreÃ§o SolidÃ¡rio','Rec. SolidÃ¡rio','Qtd Inteira','PreÃ§o Inteira','Rec. Inteira','Receita Total']];
    show.sectors.forEach(s => sr.push([s.name, s.capacity, s.qtyMeia, s.priceMeia, s.qtyMeia*s.priceMeia, s.qtySolidario, s.priceSolidario, s.qtySolidario*s.priceSolidario, s.qtyInteira, s.priceInteira, s.qtyInteira*s.priceInteira, calcSectorRevenue(s)]));
    const ws2 = XLSX.utils.aoa_to_sheet(sr); ws2['!cols'] = sr[0].map(() => ({ wch: 18 }));
    XLSX.utils.book_append_sheet(wb, ws2, `Show ${i+1} - ${v?.city||''}`);
  });
  XLSX.writeFile(wb, `${budget.name||'orÃ§amento'}.xlsx`);
}

// â”€â”€â”€ SHARED UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NInput({ value, onChange, prefix = 'R$', className = '', step = '1', min = 0 }) {
  return (
    <div className={`flex items-center border border-slate-200 rounded overflow-hidden bg-white ${className}`}>
      {prefix && <span className="px-1.5 text-xs text-slate-400 bg-slate-50 border-r border-slate-200 py-1.5 whitespace-nowrap select-none">{prefix}</span>}
      <input type="number" value={value} min={min} step={step}
        onChange={e => onChange(parseFloat(e.target.value) || 0)}
        className="w-full px-1.5 py-1.5 text-xs text-slate-800 outline-none bg-white text-right" />
    </div>
  );
}

function DRERow({ label, value, bold, sub, green, red, border }) {
  return (
    <div className={`flex justify-between items-center py-1 px-3 ${border ? 'border-t border-slate-200 mt-1 pt-2' : ''}`}>
      <span className={`text-xs ${sub ? 'text-slate-400 pl-2' : bold ? 'text-slate-700 font-semibold' : 'text-slate-600'}`}>{label}</span>
      <span className={`text-xs font-mono ${green ? 'text-emerald-600 font-semibold' : red ? 'text-red-500 font-semibold' : bold ? 'text-slate-800 font-semibold' : 'text-slate-500'}`}>{fmtR(value)}</span>
    </div>
  );
}

// â”€â”€â”€ DRE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DREPanel({ show }) {
  const { allVenueMap } = useContext(VenueCtx);
  const c = useMemo(() => show ? calcShow(show, allVenueMap) : null, [show, allVenueMap]);
  if (!show || !c) return <div className="h-full flex items-center justify-center text-slate-400 text-sm text-center px-4">Selecione um show para ver a DRE</div>;
  const venue = allVenueMap[show.venueId];
  const cc = show.categoryCosts || {};

  return (
    <div className="space-y-2">
      <div className="bg-slate-700 rounded-lg p-3 mb-2">
        <p className="text-white font-semibold text-sm truncate">{venue?.name}</p>
        <p className="text-slate-300 text-xs">{venue?.city}, {venue?.state}</p>
        {show.date && <p className="text-slate-400 text-xs mt-0.5">{show.date}</p>}
        <div className="grid grid-cols-3 gap-2 mt-2">
          <div><p className="text-slate-400 text-xs">Vendido</p><p className="text-white text-xs font-semibold">{c.totalSold.toLocaleString('pt-BR')}</p></div>
          <div><p className="text-slate-400 text-xs">OcupaÃ§Ã£o</p><p className={`text-xs font-semibold ${c.occupancy>=0.9?'text-emerald-400':c.occupancy>=0.7?'text-yellow-400':'text-red-400'}`}>{fmtPct(c.occupancy)}</p></div>
          <div><p className="text-slate-400 text-xs">Ticket MÃ©dio</p><p className="text-emerald-300 text-xs font-semibold">{fmtR(c.ticketMedio)}</p></div>
        </div>
      </div>

      <div className="bg-white rounded-lg border border-slate-100 overflow-hidden">
        <div className="bg-emerald-50 px-3 py-1.5 border-b"><p className="text-xs font-semibold text-emerald-700">RECEITAS</p></div>
        {show.sectors.map(s => <DRERow key={s.id} label={s.name} value={calcSectorRevenue(s)} sub />)}
        <DRERow label="Receita Bruta" value={c.revenue} bold border />
      </div>

      {DRE_CATS.map(cat => {
        const templateItems = cat.keys.map(k => ({ k, label: COST_LABELS[k], val: c[k] })).filter(x => x.val > 0);
        const customItems   = (cc[cat.id] || []).filter(e => parseFloat(e.value) > 0);
        const catCustomTotal = c.catCosts?.[cat.id] || 0;
        if (!templateItems.length && !catCustomTotal) return null;
        const catTotal = templateItems.reduce((s, x) => s + x.val, 0) + catCustomTotal;
        return (
          <div key={cat.id} className="bg-white rounded-lg border border-slate-100 overflow-hidden">
            <div className={`${cat.hBg} px-3 py-1 border-b border-slate-100`}><p className={`text-xs font-semibold ${cat.hTxt}`}>{cat.label.toUpperCase()}</p></div>
            {templateItems.map(x => <DRERow key={x.k} label={x.label} value={x.val} sub />)}
            {customItems.map(e => <DRERow key={e.id} label={e.description || 'Custo adicional'} value={parseFloat(e.value)||0} sub />)}
            {(templateItems.length + customItems.length) > 1 && <DRERow label="Subtotal" value={catTotal} bold border />}
          </div>
        );
      })}

      <div className="bg-white rounded-lg border border-slate-200"><DRERow label="Total Custos" value={c.totalCosts} bold /></div>
      <div className={`rounded-lg p-3 ${c.result>=0?'bg-emerald-50 border border-emerald-200':'bg-red-50 border border-red-200'}`}>
        <div className="flex justify-between"><span className="text-sm font-bold text-slate-700">Resultado</span><span className={`text-sm font-bold font-mono ${c.result>=0?'text-emerald-600':'text-red-600'}`}>{fmtR(c.result)}</span></div>
        <div className="flex justify-between mt-0.5"><span className="text-xs text-slate-500">Margem lÃ­quida</span><span className={`text-sm font-semibold ${c.margin>=0?'text-emerald-600':'text-red-600'}`}>{fmtPct(c.margin)}</span></div>
      </div>
    </div>
  );
}

// â”€â”€â”€ SECTOR TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SectorTable({ show, onUpdateShow }) {
  const { allVenueMap } = useContext(VenueCtx);
  const solidarioPct = show.solidarioPct != null ? show.solidarioPct : DEFAULT_SOLIDARIO_PCT;

  const updateSector = (sectorId, updates) =>
    onUpdateShow({ ...show, sectors: show.sectors.map(s => s.id === sectorId ? { ...s, ...updates } : s) });

  const handlePriceInteiraChange = (sectorId, newInteira) =>
    updateSector(sectorId, {
      priceInteira:   newInteira,
      priceMeia:      parseFloat((newInteira * 0.5).toFixed(2)),
      priceSolidario: parseFloat((newInteira * solidarioPct / 100).toFixed(2)),
    });

  const handleCapacityChange = (sectorId, newCap) => {
    const sp = show.splits || DEFAULT_SPLITS;
    updateSector(sectorId, {
      capacity:     newCap,
      qtyMeia:      Math.round(newCap * sp.meia),
      qtySolidario: Math.round(newCap * sp.solidario),
      qtyInteira:   Math.round(newCap * sp.inteira),
    });
  };

  const totalRevenue = show.sectors.reduce((s, sec) => s + calcSectorRevenue(sec), 0);
  const totalSold    = show.sectors.reduce((s, sec) => s + sec.qtyMeia + sec.qtySolidario + sec.qtyInteira, 0);
  const totalCap     = show.sectors.reduce((s, sec) => s + sec.capacity, 0);

  const thCls   = "px-2 py-2 text-center text-xs font-semibold text-white whitespace-nowrap";
  const tdCls   = "px-1 py-1";
  const inputSm = "w-16 border border-slate-200 rounded text-xs text-right px-1 py-1 outline-none bg-white focus:ring-1 focus:ring-blue-300";
  const inputMd = "w-20 border border-slate-200 rounded text-xs text-right px-1 py-1 outline-none bg-white focus:ring-1 focus:ring-blue-300";
  const inputCp = "w-16 border border-amber-300 rounded text-xs text-center px-1 py-1 outline-none bg-amber-50 focus:ring-1 focus:ring-amber-300 font-semibold text-amber-800";

  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm border-collapse" style={{ minWidth: '950px' }}>
        <thead>
          <tr>
            <th rowSpan={2} className="bg-slate-700 text-left px-3 py-2 text-xs font-semibold text-white rounded-tl-lg" style={{ minWidth: '130px' }}>Setor</th>
            <th rowSpan={2} className="bg-amber-700 text-center px-2 py-2 text-xs font-semibold text-white" title="EditÃ¡vel â€” altera e recalcula qtds">Cap. âœŽ</th>
            <th colSpan={3} className="bg-blue-800 text-center px-2 py-1.5 text-xs font-semibold text-white border-l border-blue-600">Meia Entrada (50%)</th>
            <th colSpan={3} className="bg-violet-800 text-center px-2 py-1.5 text-xs font-semibold text-white border-l border-violet-600">SolidÃ¡rio ({solidarioPct.toFixed(1)}%)</th>
            <th colSpan={3} className="bg-slate-800 text-center px-2 py-1.5 text-xs font-semibold text-white border-l border-slate-600">Inteira (100%)</th>
            <th rowSpan={2} className="bg-emerald-800 text-center px-2 py-2 text-xs font-semibold text-white rounded-tr-lg border-l border-emerald-600">Receita</th>
          </tr>
          <tr>
            <th className={`${thCls} bg-blue-700 border-l border-blue-600`}>Qtd</th><th className={`${thCls} bg-blue-700`}>PreÃ§o</th><th className={`${thCls} bg-blue-700`}>Total</th>
            <th className={`${thCls} bg-violet-700 border-l border-violet-600`}>Qtd</th><th className={`${thCls} bg-violet-700`}>PreÃ§o</th><th className={`${thCls} bg-violet-700`}>Total</th>
            <th className={`${thCls} bg-slate-600 border-l border-slate-500`}>Qtd</th><th className={`${thCls} bg-slate-600`}>PreÃ§o</th><th className={`${thCls} bg-slate-600`}>Total</th>
          </tr>
        </thead>
        <tbody>
          {show.sectors.map((sec, i) => {
            const revMeia = sec.qtyMeia * sec.priceMeia;
            const revSol  = sec.qtySolidario * sec.priceSolidario;
            const revInt  = sec.qtyInteira * sec.priceInteira;
            return (
              <tr key={sec.id} className={i%2===0?'bg-white':'bg-slate-50'}>
                <td className="px-3 py-1.5">
                  <input value={sec.name} onChange={e => updateSector(sec.id, { name: e.target.value })}
                    className="w-full text-xs text-slate-700 bg-transparent outline-none border-b border-transparent hover:border-slate-300 focus:border-blue-400" />
                </td>
                <td className="px-1 py-1.5 text-center">
                  <input type="number" value={sec.capacity} min={0} onChange={e => handleCapacityChange(sec.id, parseInt(e.target.value)||0)} className={inputCp} />
                </td>
                <td className={`${tdCls} border-l border-blue-100`}><input type="number" value={sec.qtyMeia} min={0} onChange={e => updateSector(sec.id,{qtyMeia:parseInt(e.target.value)||0})} className={inputSm}/></td>
                <td className={tdCls}><input type="number" value={sec.priceMeia} min={0} step="0.01" onChange={e => updateSector(sec.id,{priceMeia:parseFloat(e.target.value)||0})} className={inputMd}/></td>
                <td className={`${tdCls} text-right text-xs font-mono text-blue-700`}>{fmtR(revMeia)}</td>
                <td className={`${tdCls} border-l border-violet-100`}><input type="number" value={sec.qtySolidario} min={0} onChange={e => updateSector(sec.id,{qtySolidario:parseInt(e.target.value)||0})} className={inputSm}/></td>
                <td className={tdCls}><input type="number" value={sec.priceSolidario} min={0} step="0.01" onChange={e => updateSector(sec.id,{priceSolidario:parseFloat(e.target.value)||0})} className={inputMd}/></td>
                <td className={`${tdCls} text-right text-xs font-mono text-violet-700`}>{fmtR(revSol)}</td>
                <td className={`${tdCls} border-l border-slate-200`}><input type="number" value={sec.qtyInteira} min={0} onChange={e => updateSector(sec.id,{qtyInteira:parseInt(e.target.value)||0})} className={inputSm}/></td>
                <td className={tdCls}><input type="number" value={sec.priceInteira} min={0} step="0.01" onChange={e => handlePriceInteiraChange(sec.id, parseFloat(e.target.value)||0)} className={inputMd+' font-semibold'}/></td>
                <td className={`${tdCls} text-right text-xs font-mono text-slate-700`}>{fmtR(revInt)}</td>
                <td className="px-2 py-1.5 text-right text-xs font-mono font-semibold text-emerald-700 border-l border-emerald-100">{fmtR(revMeia+revSol+revInt)}</td>
              </tr>
            );
          })}
          <tr className="bg-slate-700">
            <td className="px-3 py-2 text-xs text-white font-semibold">TOTAL</td>
            <td className="px-1 py-2 text-center text-xs text-amber-300 font-mono font-semibold">{totalCap.toLocaleString('pt-BR')}</td>
            <td className="px-1 py-2 text-center text-xs text-slate-300 border-l border-slate-600">{show.sectors.reduce((s,sec)=>s+sec.qtyMeia,0)}</td><td></td>
            <td className="px-1 py-2 text-right text-xs font-mono text-blue-300">{fmtR(show.sectors.reduce((s,sec)=>s+sec.qtyMeia*sec.priceMeia,0))}</td>
            <td className="px-1 py-2 text-center text-xs text-slate-300 border-l border-slate-600">{show.sectors.reduce((s,sec)=>s+sec.qtySolidario,0)}</td><td></td>
            <td className="px-1 py-2 text-right text-xs font-mono text-violet-300">{fmtR(show.sectors.reduce((s,sec)=>s+sec.qtySolidario*sec.priceSolidario,0))}</td>
            <td className="px-1 py-2 text-center text-xs text-slate-300 border-l border-slate-600">{show.sectors.reduce((s,sec)=>s+sec.qtyInteira,0)}</td><td></td>
            <td className="px-1 py-2 text-right text-xs font-mono text-slate-300">{fmtR(show.sectors.reduce((s,sec)=>s+sec.qtyInteira*sec.priceInteira,0))}</td>
            <td className="px-2 py-2 text-right text-sm font-mono font-bold text-white border-l border-emerald-600">{fmtR(totalRevenue)}</td>
          </tr>
        </tbody>
      </table>
      <div className="mt-2 flex flex-wrap items-center gap-5 text-xs text-slate-500">
        <span>Capacidade total: <strong className="text-amber-700">{totalCap.toLocaleString('pt-BR')}</strong></span>
        <span>Total vendido: <strong className="text-slate-700">{totalSold.toLocaleString('pt-BR')}</strong></span>
        <span className="text-emerald-600 font-semibold bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-200">
          ðŸŽŸ Ticket mÃ©dio: {totalSold>0 ? fmtR(totalRevenue/totalSold) : 'â€”'}
        </span>
        <button onClick={() => onUpdateShow({...show, sectors:[...show.sectors,{id:uid(),name:'NOVO SETOR',capacity:0,qtyMeia:0,priceMeia:0,qtySolidario:0,priceSolidario:0,qtyInteira:0,priceInteira:0}]})} className="text-blue-600 hover:text-blue-800 ml-auto">+ Setor</button>
        <button onClick={() => {
          const venue = allVenueMap[show.venueId];
          if (!venue || !confirm('Restaurar setores do template?')) return;
          const sp  = show.splits || DEFAULT_SPLITS;
          const sol = show.solidarioPct != null ? show.solidarioPct : DEFAULT_SOLIDARIO_PCT;
          onUpdateShow({...show, sectors: venue.sectors.map(s => ({id:s.id,name:s.name,capacity:s.capacity,...defaultSectorQtys(s,sp,sol)}))});
        }} className="text-amber-600 hover:text-amber-800">â†º Restaurar template</button>
      </div>
    </div>
  );
}

// â”€â”€â”€ GLOBAL SPLITS + SOLIDÃRIO EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function GlobalSplitsEditor({ show, onUpdateShow }) {
  const sp  = show.splits || DEFAULT_SPLITS;
  const sol = show.solidarioPct != null ? show.solidarioPct : DEFAULT_SOLIDARIO_PCT;
  const [localSplits,    setLocalSplits]    = useState({ meia: Math.round(sp.meia*100), solidario: Math.round(sp.solidario*100), inteira: Math.round(sp.inteira*100) });
  const [localSolidario, setLocalSolidario] = useState(sol);

  useEffect(() => {
    const s = show.splits || DEFAULT_SPLITS;
    setLocalSplits({ meia: Math.round(s.meia*100), solidario: Math.round(s.solidario*100), inteira: Math.round(s.inteira*100) });
    setLocalSolidario(show.solidarioPct != null ? show.solidarioPct : DEFAULT_SOLIDARIO_PCT);
  }, [show.id]);

  const sum   = localSplits.meia + localSplits.solidario + localSplits.inteira;
  const valid = Math.abs(sum - 100) < 0.5;

  const applySplits = () => {
    if (!valid) return;
    const splits = { meia: localSplits.meia/100, solidario: localSplits.solidario/100, inteira: localSplits.inteira/100 };
    onUpdateShow({ ...show, splits, sectors: show.sectors.map(s => ({ ...s, qtyMeia: Math.round(s.capacity*splits.meia), qtySolidario: Math.round(s.capacity*splits.solidario), qtyInteira: Math.round(s.capacity*splits.inteira) })) });
  };

  const applySolidario = () => {
    const pct = localSolidario;
    onUpdateShow({ ...show, solidarioPct: pct, sectors: show.sectors.map(s => ({ ...s, priceSolidario: parseFloat((s.priceInteira * pct / 100).toFixed(2)) })) });
  };

  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-4">
      {/* Distribution splits */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <div>
            <label className="text-xs font-semibold text-blue-700 uppercase tracking-wide">DistribuiÃ§Ã£o por Tipo de Ingresso</label>
            <p className="text-xs text-blue-500 mt-0.5">Aplica % a todos os setores com base na capacidade</p>
          </div>
          <span className={`text-xs font-bold px-2 py-1 rounded-full ${valid?'bg-emerald-100 text-emerald-700':'bg-red-100 text-red-600'}`}>Soma: {sum}%</span>
        </div>
        <div className="grid grid-cols-3 gap-3 mb-2">
          {[{key:'meia',label:'Meia Entrada',color:'blue'},{key:'solidario',label:'SolidÃ¡rio',color:'violet'},{key:'inteira',label:'Inteira',color:'slate'}].map(({key,label,color})=>(
            <div key={key}>
              <label className={`block text-xs font-semibold text-${color}-700 mb-1`}>{label}</label>
              <div className="flex items-center border border-slate-200 rounded overflow-hidden bg-white">
                <input type="number" value={localSplits[key]} min={0} max={100} step={1} onChange={e=>setLocalSplits(p=>({...p,[key]:parseFloat(e.target.value)||0}))} className="w-full text-right px-2 py-1.5 text-sm font-semibold outline-none"/>
                <span className="px-2 text-slate-400 text-xs bg-slate-50 border-l border-slate-200 py-1.5 select-none">%</span>
              </div>
            </div>
          ))}
        </div>
        <button onClick={applySplits} disabled={!valid} className={`w-full py-2 rounded-lg text-xs font-semibold transition-colors ${valid?'bg-blue-600 hover:bg-blue-700 text-white':'bg-slate-200 text-slate-400 cursor-not-allowed'}`}>
          {valid ? 'âœ“ Aplicar distribuiÃ§Ã£o a todos os setores' : `Soma deve ser 100% (atual: ${sum}%)`}
        </button>
      </div>

      {/* SolidÃ¡rio % of Inteira */}
      <div className="border-t border-blue-200 pt-4">
        <div className="mb-2">
          <label className="text-xs font-semibold text-violet-700 uppercase tracking-wide">PreÃ§o SolidÃ¡rio (% do PreÃ§o Inteira)</label>
          <p className="text-xs text-blue-500 mt-0.5">Atualiza priceSolidÃ¡rio em todos os setores â€” Meia sempre = 50%</p>
        </div>
        <div className="flex gap-2">
          <div className="flex items-center border border-slate-200 rounded overflow-hidden bg-white flex-1">
            <span className="px-2 text-xs text-violet-600 font-semibold bg-violet-50 border-r border-slate-200 py-1.5 whitespace-nowrap">SolidÃ¡rio Ã©</span>
            <input type="number" value={localSolidario} min={0} max={100} step={0.5}
              onChange={e => setLocalSolidario(parseFloat(e.target.value)||0)}
              className="w-full text-right px-2 py-1.5 text-sm font-semibold outline-none text-violet-700"/>
            <span className="px-2 text-violet-500 text-xs bg-violet-50 border-l border-slate-200 py-1.5 whitespace-nowrap">% da Inteira</span>
          </div>
          <button onClick={applySolidario} className="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg text-xs font-semibold whitespace-nowrap">
            âœ“ Aplicar
          </button>
        </div>
        <p className="text-xs text-slate-400 mt-1.5">Atual: SolidÃ¡rio = {localSolidario}% Â· Meia = 50% Â· Inteira = 100%</p>
      </div>
    </div>
  );
}

// â”€â”€â”€ LOCAÃ‡ÃƒO EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LocacaoEditor({ show, onUpdateShow, venue }) {
  const locOv = show.locacaoOverride || DEFAULT_LOCACAO_OV;

  const tplLabel = venue
    ? venue.costs.locacaoType === 'pct'
      ? `Template â€” ${(venue.costs.locacaoValue*100).toFixed(0)}% da receita`
      : `Template â€” ${fmtR(venue.costs.locacaoValue)} fixo`
    : 'Template';

  const setType  = type  => onUpdateShow({ ...show, locacaoOverride: { ...locOv, type } });
  const setValue = value => onUpdateShow({ ...show, locacaoOverride: { ...locOv, value: parseFloat(value)||0 } });
  const setPct   = pct   => onUpdateShow({ ...show, locacaoOverride: { ...locOv, pct: parseFloat(pct)||0 } });

  return (
    <div>
      <div className="flex flex-wrap gap-3 mb-2">
        {[['template',tplLabel],['fixed','Valor Fixo'],['pct','% da Receita']].map(([t,lbl])=>(
          <label key={t} className="flex items-center gap-1.5 text-xs cursor-pointer text-slate-600">
            <input type="radio" checked={locOv.type===t} onChange={()=>setType(t)} className="accent-purple-600"/>
            <span className={locOv.type===t?'font-semibold text-purple-700':''}>{lbl}</span>
          </label>
        ))}
      </div>
      {locOv.type === 'fixed' && (
        <div className="flex items-center border border-purple-300 rounded-lg overflow-hidden bg-white max-w-xs">
          <span className="px-2 text-xs text-purple-600 bg-purple-50 border-r border-purple-200 py-2">R$</span>
          <input type="number" value={locOv.value} min={0} step="100"
            onChange={e => setValue(e.target.value)}
            className="flex-1 text-right px-2 py-2 text-sm outline-none" placeholder="0"/>
        </div>
      )}
      {locOv.type === 'pct' && (
        <div className="flex items-center gap-2">
          <div className="flex items-center border border-purple-300 rounded-lg overflow-hidden bg-white w-40">
            <input type="number" value={locOv.pct} min={0} max={100} step="0.5"
              onChange={e => setPct(e.target.value)}
              className="flex-1 text-right px-2 py-2 text-sm outline-none" placeholder="0"/>
            <span className="px-2 text-xs text-purple-600 bg-purple-50 border-l border-purple-200 py-2">%</span>
          </div>
          <span className="text-xs text-slate-400">da receita bruta</span>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ CATEGORY COSTS EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CatCostLines({ catId, show, onUpdateShow }) {
  const items = (show.categoryCosts || {})[catId] || [];
  const cc = show.categoryCosts || {};

  const addItem = () => onUpdateShow({ ...show, categoryCosts: { ...cc, [catId]: [...items, { id: uid(), description: '', value: 0 }] } });
  const removeItem = id => onUpdateShow({ ...show, categoryCosts: { ...cc, [catId]: items.filter(e => e.id !== id) } });
  const updateItem = (id, f, v) => onUpdateShow({ ...show, categoryCosts: { ...cc, [catId]: items.map(e => e.id === id ? { ...e, [f]: v } : e) } });

  return (
    <div>
      {items.map(ec => (
        <div key={ec.id} className="flex gap-2 mt-1.5">
          <input value={ec.description} placeholder="DescriÃ§Ã£o do custo" onChange={e => updateItem(ec.id, 'description', e.target.value)}
            className="flex-1 border border-slate-200 rounded px-2 py-1.5 text-xs outline-none focus:ring-1 focus:ring-blue-300 bg-white" />
          <div className="flex items-center border border-slate-200 rounded overflow-hidden bg-white w-32">
            <span className="px-1.5 text-xs text-slate-400 bg-slate-50 border-r border-slate-200 py-1.5">R$</span>
            <input type="number" value={ec.value} min={0} step="0.01" onChange={e => updateItem(ec.id, 'value', parseFloat(e.target.value)||0)}
              className="w-full text-right text-xs px-1.5 py-1.5 outline-none bg-white" />
          </div>
          <button onClick={() => removeItem(ec.id)} className="text-slate-300 hover:text-red-500 text-sm px-1">âœ•</button>
        </div>
      ))}
      <button onClick={addItem} className="mt-2 text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1">
        <span>+</span> Adicionar linha de custo
      </button>
    </div>
  );
}

// â”€â”€â”€ SHOW FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ShowForm({ show, onUpdateShow }) {
  const { allVenueMap } = useContext(VenueCtx);
  const venue = allVenueMap[show.venueId];
  const ov    = show.costOverrides || {};
  const updateOverride = (key, val) => onUpdateShow({ ...show, costOverrides: { ...ov, [key]: val === '' ? null : parseFloat(val)||0 } });

  return (
    <div className="space-y-6">
      {/* Date + Cachet */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Data do Show</label>
          <input type="date" value={show.date} onChange={e => onUpdateShow({...show, date: e.target.value})}
            className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200" />
        </div>
        <div>
          <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">CachÃª do Artista</label>
          <NInput value={show.cachet} onChange={v => onUpdateShow({...show, cachet: v})} className="w-full" />
        </div>
      </div>

      {/* Splits + SolidÃ¡rio */}
      <GlobalSplitsEditor show={show} onUpdateShow={onUpdateShow} />

      {/* Sector table */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="text-xs font-semibold text-slate-500 uppercase tracking-wide">PrecificaÃ§Ã£o por Setor</label>
          <span className="text-xs text-slate-400">Cap. (Ã¢mbar) editÃ¡vel Â· Inteira â†’ Meia/SolidÃ¡rio auto-atualizam</span>
        </div>
        <SectorTable show={show} onUpdateShow={onUpdateShow} />
      </div>

      {/* Categorized costs */}
      {venue && (
        <div className="space-y-3">
          <div>
            <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-0.5">Custos de ProduÃ§Ã£o</label>
            <p className="text-xs text-slate-400">ECAD e ISS+PIS sÃ£o calculados automaticamente. Deixe em branco para usar template do venue.</p>
          </div>

          {/* Venue / LocaÃ§Ã£o â€” special editor */}
          <div className="border border-slate-200 rounded-lg overflow-hidden">
            <div className="bg-purple-50 px-4 py-2 border-b border-slate-200 flex items-center justify-between">
              <p className="text-xs font-semibold text-purple-700 uppercase tracking-wide">Venue â€” LocaÃ§Ã£o</p>
            </div>
            <div className="px-4 py-3 bg-white">
              <LocacaoEditor show={show} onUpdateShow={onUpdateShow} venue={venue} />
            </div>
            <div className="px-4 pb-3 bg-white border-t border-dashed border-slate-200">
              <p className="text-xs text-slate-400 mb-1 mt-2">Custos adicionais de Venue</p>
              <CatCostLines catId="venue" show={show} onUpdateShow={onUpdateShow} />
            </div>
          </div>

          {/* Other categories */}
          {OVERRIDE_CATS.map(cat => {
            const items = cat.keys.map(key => ({
              key, label: COST_LABELS[key],
              dflt: venue.costs[key] ?? 0,
            }));
            return (
              <div key={cat.id} className="border border-slate-200 rounded-lg overflow-hidden">
                <div className={`${cat.hBg} px-4 py-2 border-b border-slate-200 flex items-center justify-between`}>
                  <p className={`text-xs font-semibold ${cat.hTxt} uppercase tracking-wide`}>{cat.label}</p>
                  <span className="text-xs text-slate-400 font-normal normal-case">Edite direto Â· â†º volta ao template</span>
                </div>
                <table className="w-full text-sm">
                  <tbody>
                    {items.map((item, i) => {
                      const isOv   = ov[item.key] != null;
                      const effVal = isOv ? ov[item.key] : item.dflt;
                      return (
                        <tr key={item.key} className={i%2===0?'bg-white':'bg-slate-50/30'}>
                          <td className="px-4 py-1.5 text-xs text-slate-700">{item.label}</td>
                          {isOv && (
                            <td className="px-2 py-1.5 text-right text-xs text-slate-400 font-mono whitespace-nowrap">
                              tmpl: {fmtR(item.dflt)}
                            </td>
                          )}
                          <td className={`px-2 py-1.5 ${isOv?'':'pl-4'}`} colSpan={isOv?1:2}>
                            <div className={`flex items-center border rounded overflow-hidden bg-white w-44 ml-auto ${isOv?'border-blue-400':'border-slate-200 hover:border-slate-300'}`}>
                              <span className={`text-xs px-2 border-r py-1.5 shrink-0 select-none ${isOv?'text-blue-600 bg-blue-50 border-blue-200':'text-slate-400 bg-slate-50 border-slate-200'}`}>R$</span>
                              <input type="number" min={0} step="1"
                                value={effVal}
                                onChange={e => updateOverride(item.key, e.target.value)}
                                className={`w-full text-right text-xs px-2 py-1.5 outline-none bg-white ${isOv?'text-blue-700 font-semibold':'text-slate-600'}`}/>
                              {isOv && (
                                <button onClick={() => updateOverride(item.key, '')} title="Restaurar ao template" className="px-1.5 text-blue-400 hover:text-red-500 text-xs border-l border-blue-200 bg-blue-50 py-1.5 shrink-0">â†º</button>
                              )}
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
                {/* Custom costs for this category */}
                <div className="px-4 py-3 bg-white border-t border-dashed border-slate-200">
                  <p className="text-xs text-slate-400 mb-1">Custos adicionais de {cat.label}</p>
                  <CatCostLines catId={cat.id} show={show} onUpdateShow={onUpdateShow} />
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ CREATE VENUE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CreateVenueModal({ onSave, onClose }) {
  const [info,    setInfo]    = useState({ name:'', city:'', state:'', cortesias:0 });
  const [sectors, setSectors] = useState([{ id: uid(), name:'PLATEIA', capacity:1000, priceInteira:200 }]);
  const [costs,   setCosts]   = useState({ locacaoType:'fixed', locacaoValue:0, producao:0, logistica:0, backline:0, iluminacao:0, som:0, led:0, outros:0 });
  const [taxes,   setTaxes]   = useState({ issPis:5.65, ecad:4.0 });

  const totalCap = sectors.reduce((s, sec) => s + (parseInt(sec.capacity)||0), 0);
  const addSec   = ()         => setSectors(p => [...p, {id:uid(),name:'SETOR',capacity:500,priceInteira:100}]);
  const remSec   = id         => setSectors(p => p.filter(s => s.id !== id));
  const updSec   = (id,f,v)  => setSectors(p => p.map(s => s.id===id ? {...s,[f]:v} : s));
  const updC     = (f,v)     => setCosts(p => ({...p,[f]:v}));
  const updT     = (f,v)     => setTaxes(p => ({...p,[f]:v}));

  const handleSave = () => {
    if (!info.name || !info.city || !info.state || !sectors.length) { alert('Preencha nome, cidade, estado e ao menos um setor.'); return; }
    onSave({
      id:`custom-${uid()}`, custom:true,
      name:info.name, city:info.city, state:info.state.toUpperCase().slice(0,2),
      totalCapacity:totalCap, cortesias:parseInt(info.cortesias)||0,
      sectors: sectors.map(s => ({ id:s.id, name:s.name, capacity:parseInt(s.capacity)||0, priceInteira:parseFloat(s.priceInteira)||0, splitMeia:0.4, splitSolidario:0.5, splitInteira:0.1 })),
      costs: { locacaoType:costs.locacaoType, locacaoValue: costs.locacaoType==='pct' ? (parseFloat(costs.locacaoValue)||0)/100 : parseFloat(costs.locacaoValue)||0, producao:parseFloat(costs.producao)||0, logistica:parseFloat(costs.logistica)||0, backline:parseFloat(costs.backline)||0, iluminacao:parseFloat(costs.iluminacao)||0, som:parseFloat(costs.som)||0, led:parseFloat(costs.led)||0, outros:parseFloat(costs.outros)||0 },
      taxes: { issPis:(parseFloat(taxes.issPis)||0)/100, ecad:(parseFloat(taxes.ecad)||0)/100 },
    });
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-start justify-center overflow-y-auto p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-4">
        <div className="flex items-center justify-between p-5 border-b">
          <div><h3 className="font-bold text-slate-800 text-lg">Criar Novo Venue</h3><p className="text-slate-400 text-xs mt-0.5">Salvo no navegador</p></div>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-xl">âœ•</button>
        </div>
        <div className="p-5 space-y-5 overflow-y-auto" style={{maxHeight:'72vh'}}>
          {/* Info */}
          <div>
            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">InformaÃ§Ãµes BÃ¡sicas</h4>
            <div className="grid grid-cols-2 gap-3">
              <div className="col-span-2"><label className="block text-xs text-slate-500 mb-1">Nome *</label><input value={info.name} onChange={e=>setInfo(p=>({...p,name:e.target.value}))} placeholder="Teatro Municipal" className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"/></div>
              <div><label className="block text-xs text-slate-500 mb-1">Cidade *</label><input value={info.city} onChange={e=>setInfo(p=>({...p,city:e.target.value}))} placeholder="SÃ£o Paulo" className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"/></div>
              <div><label className="block text-xs text-slate-500 mb-1">UF *</label><input value={info.state} onChange={e=>setInfo(p=>({...p,state:e.target.value}))} placeholder="SP" maxLength={2} className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200 uppercase"/></div>
              <div><label className="block text-xs text-slate-500 mb-1">Cortesias</label><input type="number" value={info.cortesias} min={0} onChange={e=>setInfo(p=>({...p,cortesias:e.target.value}))} className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200"/></div>
            </div>
          </div>
          {/* Sectors */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <div><h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Setores</h4><p className="text-xs text-slate-400">Total: <strong>{totalCap.toLocaleString('pt-BR')}</strong> lugares</p></div>
              <button onClick={addSec} className="text-xs text-blue-600 hover:text-blue-800 font-medium">+ Setor</button>
            </div>
            <div className="border border-slate-200 rounded-lg overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-slate-50 text-xs"><tr><th className="text-left px-3 py-2 font-semibold text-slate-600">Setor</th><th className="text-right px-3 py-2 font-semibold text-slate-600">Capacidade</th><th className="text-right px-3 py-2 font-semibold text-slate-600">Inteira</th><th className="px-2"></th></tr></thead>
                <tbody>
                  {sectors.map((sec,i)=>(
                    <tr key={sec.id} className={i%2===0?'bg-white':'bg-slate-50'}>
                      <td className="px-2 py-1.5"><input value={sec.name} onChange={e=>updSec(sec.id,'name',e.target.value)} className="w-full border border-slate-200 rounded px-2 py-1 text-xs outline-none"/></td>
                      <td className="px-2 py-1.5"><input type="number" value={sec.capacity} min={0} onChange={e=>updSec(sec.id,'capacity',e.target.value)} className="w-full border border-slate-200 rounded px-2 py-1 text-xs text-right outline-none"/></td>
                      <td className="px-2 py-1.5"><div className="flex items-center border border-slate-200 rounded overflow-hidden"><span className="px-1.5 text-xs text-slate-400 bg-slate-50 border-r py-1">R$</span><input type="number" value={sec.priceInteira} min={0} step="0.01" onChange={e=>updSec(sec.id,'priceInteira',e.target.value)} className="w-full text-right px-1.5 py-1 text-xs outline-none"/></div></td>
                      <td className="px-2 text-center">{sectors.length>1&&<button onClick={()=>remSec(sec.id)} className="text-slate-300 hover:text-red-500 text-sm">âœ•</button>}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
          {/* Costs */}
          <div>
            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Custos PadrÃ£o</h4>
            <div className="flex items-center gap-3 mb-3 p-3 bg-purple-50 border border-purple-200 rounded-lg">
              <div className="flex gap-3 shrink-0">
                {[['fixed','Valor fixo'],['pct','% receita']].map(([t,l])=>(
                  <label key={t} className="flex items-center gap-1.5 text-xs text-slate-600 cursor-pointer"><input type="radio" checked={costs.locacaoType===t} onChange={()=>updC('locacaoType',t)} className="accent-purple-600"/>{l}</label>
                ))}
              </div>
              <div className="flex items-center border border-slate-200 rounded overflow-hidden bg-white flex-1">
                <span className="px-2 text-xs text-purple-600 font-semibold bg-purple-50 border-r py-1.5">LocaÃ§Ã£o</span>
                <input type="number" value={costs.locacaoValue} min={0} step={costs.locacaoType==='pct'?'0.1':'1000'} onChange={e=>updC('locacaoValue',e.target.value)} className="flex-1 text-right px-2 py-1.5 text-xs outline-none"/>
                <span className="px-2 text-xs text-slate-400 bg-slate-50 border-l py-1.5">{costs.locacaoType==='pct'?'%':'R$'}</span>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-2">
              {[{k:'producao',l:'ProduÃ§Ã£o'},{k:'logistica',l:'LogÃ­stica'},{k:'backline',l:'Backline'},{k:'iluminacao',l:'IluminaÃ§Ã£o'},{k:'som',l:'SonorizaÃ§Ã£o'},{k:'led',l:'LED / Telas'},{k:'outros',l:'Outros'}].map(({k,l})=>(
                <div key={k} className="flex items-center border border-slate-200 rounded overflow-hidden bg-white"><span className="px-2 text-xs text-slate-500 bg-slate-50 border-r py-1.5 min-w-[90px]">{l}</span><span className="px-1 text-xs text-slate-400 py-1.5">R$</span><input type="number" value={costs[k]} min={0} step="1" onChange={e=>updC(k,e.target.value)} className="flex-1 text-right px-2 py-1.5 text-xs outline-none"/></div>
              ))}
            </div>
          </div>
          {/* Taxes */}
          <div>
            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-3">Impostos (% sobre receita)</h4>
            <div className="grid grid-cols-2 gap-3">
              {[{k:'issPis',l:'ISS+PIS/COFINS'},{k:'ecad',l:'ECAD'}].map(({k,l})=>(
                <div key={k} className="flex items-center border border-slate-200 rounded overflow-hidden bg-white"><span className="px-2 text-xs text-slate-500 bg-slate-50 border-r py-1.5 flex-1">{l}</span><input type="number" value={taxes[k]} min={0} max={100} step="0.01" onChange={e=>updT(k,e.target.value)} className="w-16 text-right px-2 py-1.5 text-xs outline-none"/><span className="px-2 text-xs text-slate-400 bg-slate-50 border-l py-1.5">%</span></div>
              ))}
            </div>
          </div>
        </div>
        <div className="p-5 border-t flex gap-3 justify-end">
          <button onClick={onClose} className="px-4 py-2 text-sm text-slate-600 border border-slate-200 rounded-lg hover:bg-slate-50">Cancelar</button>
          <button onClick={handleSave} className="px-6 py-2 text-sm font-semibold bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Criar Venue</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ DRE CONSOLIDADA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DREConsolidated({ budget, onClose }) {
  const { allVenueMap } = useContext(VenueCtx);
  const calc = calcBudget(budget, allVenueMap);
  const catMeta = Object.fromEntries(DRE_CATS.map(c => [c.id, c]));

  // Build row list, inserting catExtra rows after each category's items
  const allRows = [
    { key:'revenue',    label:'ðŸ“¥ Receita Bruta',    group:true, green:true },
    { cat:'deducoes' },
    { key:'ecad',       label:'ECAD',                indent:true },
    { key:'issPis',     label:'ISS+PIS/COFINS',       indent:true },
    { cat:'venue' },
    { key:'locacao',    label:'LocaÃ§Ã£o',              indent:true },
    { catExtra:'venue', label:'Extras Venue' },
    { cat:'prod' },
    { key:'producao',   label:'ProduÃ§Ã£o',             indent:true },
    { key:'cachet',     label:'CachÃª Artista',         indent:true },
    { catExtra:'prod',  label:'Extras ProduÃ§Ã£o' },
    { cat:'tecnica' },
    { key:'backline',   label:'Backline',             indent:true },
    { key:'iluminacao', label:'IluminaÃ§Ã£o',           indent:true },
    { key:'som',        label:'SonorizaÃ§Ã£o',          indent:true },
    { key:'led',        label:'LED / Telas',          indent:true },
    { catExtra:'tecnica', label:'Extras TÃ©cnica' },
    { cat:'logist' },
    { key:'logistica',  label:'LogÃ­stica',            indent:true },
    { catExtra:'logist', label:'Extras LogÃ­stica' },
    { cat:'outros' },
    { key:'outros',     label:'Outros',               indent:true },
    { key:'extras',     label:'Custos Extras',         indent:true },
    { catExtra:'outros', label:'Extras Outros' },
    { key:'totalCosts', label:'ðŸ“¤ Total Custos',      group:true },
    { key:'result',     label:'ðŸ’° Resultado',          group:true, result:true },
  ];

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-start justify-center overflow-y-auto p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-6xl my-4">
        <div className="flex items-center justify-between p-5 border-b">
          <div><h2 className="text-xl font-bold text-slate-800">DRE Consolidada</h2><p className="text-slate-500 text-sm">{budget.name} â€” {budget.artist}</p></div>
          <div className="flex gap-3">
            <button onClick={() => exportToExcel(budget, allVenueMap)} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-medium">â¬‡ Excel</button>
            <button onClick={() => window.print()} className="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium">ðŸ–¨ PDF</button>
            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-xl px-2">âœ•</button>
          </div>
        </div>
        {/* KPI bar */}
        <div className="grid grid-cols-4 border-b border-slate-200">
          {[
            { label:'Receita Total', val:fmtR(calc.revenue),    color:'text-emerald-700' },
            { label:'Total Custos',  val:fmtR(calc.totalCosts), color:'text-red-600' },
            { label:'Resultado',     val:fmtR(calc.result),     color:calc.result>=0?'text-emerald-700':'text-red-600' },
            { label:'Ticket MÃ©dio',  val:fmtR(calc.ticketMedio),color:'text-blue-700' },
          ].map((kpi,i)=>(
            <div key={i} className={`p-4 ${i<3?'border-r border-slate-200':''}`}>
              <p className="text-xs text-slate-500 mb-0.5">{kpi.label}</p>
              <p className={`text-base font-bold font-mono ${kpi.color}`}>{kpi.val}</p>
            </div>
          ))}
        </div>
        <div className="p-5 overflow-x-auto">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="bg-slate-800 text-white">
                <th className="text-left px-4 py-3 text-xs font-semibold rounded-tl-lg">Item</th>
                {budget.shows.map((show,i)=>{
                  const venue = allVenueMap[show.venueId];
                  return <th key={show.id} className="text-right px-4 py-3 text-xs font-semibold min-w-[130px]"><div>{venue?.name||'â€”'}</div><div className="text-slate-400 font-normal">{show.date||`Show ${i+1}`}</div></th>;
                })}
                <th className="text-right px-4 py-3 text-xs font-semibold text-blue-300 rounded-tr-lg">TOTAL</th>
              </tr>
            </thead>
            <tbody>
              {allRows.map((row, ri) => {
                if (row.cat) {
                  const meta = catMeta[row.cat]; if (!meta) return null;
                  return <tr key={`cat-${row.cat}`} className={meta.hBg}><td colSpan={budget.shows.length+2} className={`px-4 py-1.5 text-xs font-semibold ${meta.hTxt} uppercase tracking-wide`}>{meta.label}</td></tr>;
                }
                if (row.catExtra) {
                  const totalForCat = calc.shows.reduce((s, c) => s + (c?.catCosts?.[row.catExtra]||0), 0);
                  if (!totalForCat) return null;
                  return (
                    <tr key={`catEx-${row.catExtra}`} className="bg-white">
                      <td className="px-4 py-1.5 pl-8 text-xs text-slate-400 italic">{row.label}</td>
                      {calc.shows.map((c,i) => <td key={i} className="px-4 py-1.5 text-right font-mono text-xs text-slate-500">{fmtR(c?.catCosts?.[row.catExtra]||0)}</td>)}
                      <td className="px-4 py-1.5 text-right font-mono text-xs font-semibold border-l border-slate-200 text-slate-700">{fmtR(totalForCat)}</td>
                    </tr>
                  );
                }
                const bgCls = row.group ? 'bg-slate-50 font-semibold' : ri%2===0 ? 'bg-white' : 'bg-slate-50/40';
                const totalVal = calc.shows.reduce((s, c) => s + (c?.[row.key]||0), 0);
                return (
                  <tr key={row.key} className={bgCls}>
                    <td className={`px-4 py-2 text-slate-700 ${row.group?'font-semibold text-slate-800':''} ${row.indent?'pl-8 text-xs text-slate-500':''}`}>{row.label}</td>
                    {calc.shows.map((c,i) => {
                      const val = c?.[row.key]||0;
                      const color = row.result?(val>=0?'text-emerald-600 font-bold':'text-red-600 font-bold'):row.green?'text-emerald-700':'text-slate-600';
                      return <td key={i} className={`px-4 py-2 text-right font-mono text-xs ${color}`}>{val>0||row.result?fmtR(val):'â€”'}</td>;
                    })}
                    <td className={`px-4 py-2 text-right font-mono text-xs font-bold border-l border-slate-200 ${row.result?(totalVal>=0?'text-emerald-600':'text-red-600'):row.green?'text-emerald-700':'text-slate-800'}`}>{fmtR(totalVal)}</td>
                  </tr>
                );
              })}
              <tr className="bg-blue-50 border-t border-blue-200">
                <td className="px-4 py-2 text-xs font-semibold text-blue-700">ðŸŽŸ Ticket MÃ©dio</td>
                {calc.shows.map((c,i) => <td key={i} className="px-4 py-2 text-right font-mono text-xs text-blue-700 font-semibold">{fmtR(c?.ticketMedio||0)}</td>)}
                <td className="px-4 py-2 text-right font-mono text-xs font-bold text-blue-800 border-l border-slate-200">{fmtR(calc.ticketMedio)}</td>
              </tr>
              <tr className="bg-blue-50">
                <td className="px-4 py-2 text-xs font-semibold text-blue-700">Margem LÃ­quida</td>
                {calc.shows.map((c,i) => <td key={i} className={`px-4 py-2 text-right font-bold text-sm ${(c?.margin||0)>=0?'text-emerald-600':'text-red-600'}`}>{fmtPct(c?.margin)}</td>)}
                <td className={`px-4 py-2 text-right font-bold text-sm border-l border-slate-200 ${calc.margin>=0?'text-emerald-600':'text-red-600'}`}>{fmtPct(calc.margin)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Editor({ budget, onSave, onBack }) {
  const { allVenues, allVenueMap, addCustomVenue, deleteCustomVenue } = useContext(VenueCtx);
  const [local,           setLocal]          = useState(budget);
  const [activeShowId,    setActiveShowId]   = useState(local.shows[0]?.id || null);
  const [showVenueModal,  setShowVenueModal] = useState(false);
  const [showDRE,         setShowDRE]        = useState(false);
  const [showCreateVenue, setShowCreateVenue]= useState(false);
  const [venueSearch,     setVenueSearch]    = useState('');

  const activeShow = local.shows.find(s => s.id === activeShowId);
  const budgetCalc = useMemo(() => calcBudget(local, allVenueMap), [local, allVenueMap]);

  const addShow    = id => { const s = makeShow(id, allVenueMap); if (!s) return; setLocal(p=>({...p,shows:[...p.shows,s]})); setActiveShowId(s.id); setShowVenueModal(false); };
  const removeShow = id => { setLocal(p=>({...p,shows:p.shows.filter(s=>s.id!==id)})); if (activeShowId===id) setActiveShowId(local.shows.find(s=>s.id!==id)?.id||null); };
  const updateShow = u  => setLocal(p=>({...p,shows:p.shows.map(s=>s.id===u.id?u:s)}));

  const handleCreateVenue  = v  => { addCustomVenue(v); setShowCreateVenue(false); };
  const handleDeleteCustom = id => { if (!confirm('Excluir venue customizado?')) return; deleteCustomVenue(id); };

  const filtered = allVenues.filter(v => v.name.toLowerCase().includes(venueSearch.toLowerCase()) || v.city.toLowerCase().includes(venueSearch.toLowerCase()));

  return (
    <div className="flex flex-col h-screen bg-slate-50">
      <div className="bg-white border-b border-slate-200 px-6 py-3 flex items-center gap-4 shrink-0 no-print">
        <button onClick={onBack} className="text-slate-400 hover:text-slate-700 text-sm">â† Voltar</button>
        <div className="flex-1 flex items-center gap-3">
          <input value={local.name} onChange={e=>setLocal(p=>({...p,name:e.target.value}))} className="text-lg font-bold text-slate-800 bg-transparent outline-none border-b border-transparent hover:border-slate-300 focus:border-blue-400 flex-1" placeholder="Nome do OrÃ§amento"/>
          <span className="text-slate-300">|</span>
          <input value={local.artist} onChange={e=>setLocal(p=>({...p,artist:e.target.value}))} className="text-sm text-slate-500 bg-transparent outline-none border-b border-transparent hover:border-slate-300 focus:border-blue-400 w-44" placeholder="Artista"/>
        </div>
        <div className="flex items-center gap-3">
          <span className={`text-sm font-bold font-mono ${budgetCalc.result>=0?'text-emerald-600':'text-red-600'}`}>{fmtR(budgetCalc.result)}</span>
          <button onClick={()=>setShowDRE(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium">DRE Consolidada</button>
          <button onClick={()=>onSave(local)} className="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium">Salvar</button>
        </div>
      </div>
      <div className="flex flex-1 overflow-hidden">
        <div className="w-52 bg-slate-800 flex flex-col shrink-0 no-print">
          <div className="p-3 border-b border-slate-700"><p className="text-xs font-semibold text-slate-400 uppercase tracking-wide">Shows ({local.shows.length})</p></div>
          <div className="flex-1 overflow-y-auto scrollbar-thin py-2">
            {local.shows.map((show,i)=>{
              const venue = allVenueMap[show.venueId];
              const c = calcShow(show, allVenueMap);
              return (
                <div key={show.id} onClick={()=>setActiveShowId(show.id)} className={`px-3 py-3 cursor-pointer border-l-2 transition-all ${show.id===activeShowId?'bg-slate-700 border-blue-400':'border-transparent hover:border-slate-500'}`}>
                  <div className="flex items-start justify-between">
                    <div className="flex-1 min-w-0">
                      <p className="text-xs font-semibold text-white truncate">{venue?.name||'â€”'}</p>
                      <p className="text-xs text-slate-400">{venue?.city} Â· {show.date||`Show ${i+1}`}</p>
                      {c && <p className={`text-xs font-mono mt-0.5 font-semibold ${c.result>=0?'text-emerald-400':'text-red-400'}`}>{fmtR(c.result)}</p>}
                    </div>
                    <button onClick={e=>{e.stopPropagation();removeShow(show.id)}} className="text-slate-600 hover:text-red-400 ml-1 text-xs">âœ•</button>
                  </div>
                </div>
              );
            })}
          </div>
          <div className="p-3 border-t border-slate-700">
            <button onClick={()=>setShowVenueModal(true)} className="w-full bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold py-2 px-3 rounded-lg">+ Adicionar Show</button>
          </div>
        </div>
        <div className="flex-1 overflow-y-auto scrollbar-thin">
          {activeShow ? (
            <div className="max-w-5xl mx-auto p-6">
              <div className="mb-5">
                <div className="flex items-center gap-2">
                  <h3 className="text-lg font-bold text-slate-800">{allVenueMap[activeShow.venueId]?.name}</h3>
                  {allVenueMap[activeShow.venueId]?.custom && <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium">Custom</span>}
                </div>
                <p className="text-sm text-slate-500">{allVenueMap[activeShow.venueId]?.city}, {allVenueMap[activeShow.venueId]?.state} Â· Cap: {allVenueMap[activeShow.venueId]?.totalCapacity?.toLocaleString('pt-BR')} pax</p>
              </div>
              <ShowForm show={activeShow} onUpdateShow={updateShow} />
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center h-full text-slate-400">
              <p className="text-5xl mb-3">ðŸŽ¤</p>
              <p className="text-lg font-medium text-slate-600 mb-2">Nenhum show adicionado</p>
              <button onClick={()=>setShowVenueModal(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium mt-4">+ Adicionar Primeiro Show</button>
            </div>
          )}
        </div>
        <div className="w-64 bg-white border-l border-slate-200 flex flex-col shrink-0 no-print">
          <div className="p-3 border-b border-slate-200"><p className="text-xs font-semibold text-slate-500 uppercase tracking-wide">DRE â€” Show Atual</p></div>
          <div className="flex-1 overflow-y-auto scrollbar-thin p-3"><DREPanel show={activeShow} /></div>
        </div>
      </div>
      {showVenueModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
            <div className="flex items-center justify-between p-5 border-b"><h3 className="font-bold text-slate-800">Selecionar Venue</h3><button onClick={()=>setShowVenueModal(false)} className="text-slate-400 hover:text-slate-600 text-xl">âœ•</button></div>
            <div className="p-4 border-b"><input value={venueSearch} onChange={e=>setVenueSearch(e.target.value)} placeholder="Buscar por nome ou cidade..." className="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-200" autoFocus/></div>
            <div className="max-h-72 overflow-y-auto scrollbar-thin p-2">
              {filtered.map(venue=>(
                <button key={venue.id} onClick={()=>addShow(venue.id)} className="w-full text-left px-4 py-3 rounded-xl hover:bg-blue-50 flex items-center justify-between group transition-colors">
                  <div>
                    <div className="flex items-center gap-2"><p className="font-semibold text-slate-800 text-sm group-hover:text-blue-700">{venue.name}</p>{venue.custom&&<span className="text-xs bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded font-medium">Custom</span>}</div>
                    <p className="text-xs text-slate-500">{venue.city}, {venue.state} Â· {venue.totalCapacity?.toLocaleString('pt-BR')} pax Â· {venue.sectors.length} setores</p>
                  </div>
                  <div className="flex items-center gap-2">
                    {venue.custom&&<button onClick={e=>{e.stopPropagation();handleDeleteCustom(venue.id)}} className="text-slate-300 hover:text-red-400 text-xs px-1">ðŸ—‘</button>}
                    <span className="text-slate-300 group-hover:text-blue-400">â†’</span>
                  </div>
                </button>
              ))}
              {!filtered.length && <p className="text-center text-slate-400 text-sm py-4">Nenhum venue encontrado.</p>}
            </div>
            <div className="p-4 border-t">
              <button onClick={()=>{setShowVenueModal(false);setShowCreateVenue(true)}} className="w-full border-2 border-dashed border-blue-300 hover:border-blue-500 text-blue-600 py-2.5 rounded-xl text-sm font-semibold transition-colors">+ Criar Novo Venue</button>
            </div>
          </div>
        </div>
      )}
      {showCreateVenue && <CreateVenueModal onSave={handleCreateVenue} onClose={()=>setShowCreateVenue(false)} />}
      {showDRE && <DREConsolidated budget={local} onClose={()=>setShowDRE(false)} />}
    </div>
  );
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Dashboard({ budgets, onCreate, onOpen, onDelete }) {
  const { allVenueMap } = useContext(VenueCtx);
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
      <div className="max-w-5xl mx-auto px-6 py-8">
        <div className="flex items-end justify-between mb-8">
          <div><h1 className="text-3xl font-bold text-white">Venue Manager</h1><p className="text-slate-400 text-sm mt-1">ProjeÃ§Ãµes financeiras de shows e turnÃªs</p></div>
          <button onClick={onCreate} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-semibold shadow-lg">+ Novo OrÃ§amento</button>
        </div>
        {budgets.length === 0 ? (
          <div className="text-center py-24">
            <p className="text-6xl mb-4">ðŸŽ¸</p>
            <p className="text-xl font-semibold text-white mb-2">Nenhum orÃ§amento ainda</p>
            <button onClick={onCreate} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-semibold mt-4">Criar Primeiro OrÃ§amento</button>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {budgets.map(budget => {
              const calc = calcBudget(budget, allVenueMap);
              return (
                <div key={budget.id} className="bg-white/10 backdrop-blur-sm border border-white/10 rounded-2xl overflow-hidden hover:bg-white/15 transition-colors">
                  <div className="p-5">
                    <div className="flex items-start justify-between mb-3">
                      <div><h3 className="font-bold text-white">{budget.name||'Sem nome'}</h3><p className="text-slate-400 text-sm">{budget.artist||'Artista nÃ£o definido'}</p></div>
                      <button onClick={()=>onDelete(budget.id)} className="text-slate-600 hover:text-red-400 text-sm">âœ•</button>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mb-3">
                      <div><p className="text-xs text-slate-400">Shows</p><p className="text-white font-semibold">{budget.shows.length}</p></div>
                      <div><p className="text-xs text-slate-400">Receita</p><p className="text-white font-semibold font-mono text-sm">{fmtR(calc.revenue)}</p></div>
                      <div><p className="text-xs text-slate-400">Resultado</p><p className={`font-bold font-mono text-sm ${calc.result>=0?'text-emerald-400':'text-red-400'}`}>{fmtR(calc.result)}</p></div>
                      <div><p className="text-xs text-slate-400">Ticket MÃ©dio</p><p className="text-blue-300 font-semibold text-sm">{fmtR(calc.ticketMedio)}</p></div>
                    </div>
                    <div className="flex flex-wrap gap-1">
                      {budget.shows.slice(0,4).map(show=>{const venue=allVenueMap[show.venueId];return <span key={show.id} className="text-xs bg-white/10 text-slate-300 px-2 py-0.5 rounded-full">{venue?.city}</span>;})}
                      {budget.shows.length>4&&<span className="text-xs bg-white/10 text-slate-400 px-2 py-0.5 rounded-full">+{budget.shows.length-4}</span>}
                    </div>
                  </div>
                  <div className="border-t border-white/10 p-4 flex gap-2">
                    <button onClick={()=>onOpen(budget.id)} className="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg text-sm font-medium">Abrir</button>
                    <button onClick={()=>exportToExcel(budget,allVenueMap)} className="bg-emerald-600/30 hover:bg-emerald-600/50 text-emerald-300 py-2 px-3 rounded-lg text-sm">â¬‡ Excel</button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€ APP ROOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [budgets,        setBudgets]        = useState(() => loadBudgets());
  const [customVenues,   setCustomVenues]   = useState(() => loadCustomVenues());
  const [view,           setView]           = useState('dashboard');
  const [activeBudgetId, setActiveBudgetId] = useState(null);

  useEffect(() => { saveBudgets(budgets);           }, [budgets]);
  useEffect(() => { saveCustomVenues(customVenues); }, [customVenues]);

  const allVenues   = useMemo(() => [...VENUES, ...customVenues], [customVenues]);
  const allVenueMap = useMemo(() => Object.fromEntries(allVenues.map(v => [v.id, v])), [allVenues]);

  const addCustomVenue    = v  => setCustomVenues(p => [...p, v]);
  const deleteCustomVenue = id => setCustomVenues(p => p.filter(v => v.id !== id));

  const handleCreate = () => { const b = makeBudget(); setBudgets(p=>[b,...p]); setActiveBudgetId(b.id); setView('editor'); };
  const handleOpen   = id => { setActiveBudgetId(id); setView('editor'); };
  const handleSave   = u  => setBudgets(p => p.map(b => b.id===u.id ? {...u, updatedAt:new Date().toISOString()} : b));
  const handleDelete = id => { if (!confirm('Excluir orÃ§amento?')) return; setBudgets(p=>p.filter(b=>b.id!==id)); };

  const activeBudget = budgets.find(b => b.id === activeBudgetId);

  return (
    <VenueCtx.Provider value={{ allVenues, allVenueMap, addCustomVenue, deleteCustomVenue }}>
      {view==='editor' && activeBudget
        ? <Editor budget={activeBudget} onSave={handleSave} onBack={()=>setView('dashboard')} />
        : <Dashboard budgets={budgets} onCreate={handleCreate} onOpen={handleOpen} onDelete={handleDelete} />
      }
    </VenueCtx.Provider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
